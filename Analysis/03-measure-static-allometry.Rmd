---
title: "03-measure-static-allometry"
author: "Ariel Marcy"
date: "2019-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Allometry and Morphological Disparity
Changing size is one of the most common ways that organisms can also change their shape. Modifications to growth during development often have a profound impact on adult shape. The tests in this script detect how much size appears to drive shape change in our sample. 

Morphological disparity tests how much Procrustes variation exists within each group (species, clade, or wave) and whether that variation is significantly different from the variation within another group. Strong allometry can constrain variation, therefore a higher morphological disparity could suggest a species' evolution is less constrained by allometry than another's. 

### Load packages, functions, and data
```{r message = FALSE}
# library(devtools)  # needed to install dispRity package
# install_github("TGuillerme/dispRity", ref = "release")  # needed only once
library(dispRity)
library(stringr)
library(data.table)
library(geomorph)
source("../Functions/utilities.R")  # loads custom functions
load(file = "../Data/Processed/02-main-data.rda")
```

### Set up for analyses
Since Mastacomys is technically within the genus Pseudomys (Smissen & Rowe 2018), we'll make an "Effective Genus" column where this genus is classified under Pseudomys.
```{r}
# Make an Effective Genus column to better categorize Mas phylogenetically
info$EGenus <- info$Genus
info$EGenus[which(info$Genus == "Mas")] <- "Pse"  # Mas is effectively Pseudomys (Pse)
```

Colors for subsequent figures are set up according to column "EGenus":
```{r}
# Colors by EGenus: Con Hyd Leg Lep Mel Mes Mus Not Pog Pse(+Mas) Rat Uro Xer Zyz
col.gen <- c("light green", "red", "cornflowerblue", "dark green", "yellow", "green", "grey", "blue", "magenta", "dark blue", "black", "darkgoldenrod4", "orange", "light blue")

# Colors by specimen, ordered in same way as metadata
sp.col.gen <- PlotByGroup(info, "EGenus", col.gen)  # is the same for big and small protocols, tested with all.equal()

# Scheme for legend: taxa listed in order presented in phylogeny
col.phylo <- c("yellow", "darkgoldenrod4", "dark green", "green", "light green", "cornflowerblue", "light blue", "blue", "dark blue", "red", "orange", "magenta", "grey", "black")
names.phylo <- c("Mel", "Uro", "Con", "Mes", "Lep", "Leg", "Zyz", "Not", "Pse", "Hyd", "Xer", "Pog", "Mus", "Rat")
```

## 1) Measure static allometry: Homogeneity of Slopes Test by species
Isolate only those species with at least 8 specimens.
```{r}
spec.counts <- as.data.frame(table(info$Taxa))
to.remove <- spec.counts[which(spec.counts$Freq <= 7), ]
species.rm <- as.vector(to.remove$Var1)

# For loop to take out these specimens
dataset.rm <- NULL  # initiate blank data frame
for(n in 1:dim(to.remove)[1]) {
        dataset.rm <- c(dataset.rm, which(info$Taxa == species.rm[n]))
}

# Remove species from:
info.HOS <- info[c(-dataset.rm), ]  # Metadata
shape.HOS <- shape[, , c(-sort(dataset.rm))]  # Shape dataset
```

Run allometry tests as well as a homogeneity of slopes test
```{r}
# Run static allometry test
spp.gdf <- geomorph.data.frame(shape = shape.HOS, spp = info.HOS$Taxa, size = info.HOS$Csize)
spp.results <- procD.allometry(shape ~ log(size), f2 = ~spp, iter = 500, data = spp.gdf)

# Examine results
spp.results$aov.table
spp.results$HOS.test
summary(spp.results)

# Find pair-wise p-values for slopes for each taxa
size <- info$Csize
spp <- info$Taxa
pwHOS.spp <- advanced.procD.lm(f1 = shape ~log(size) + spp, 
                                     f2 = ~log(size) * spp, 
                                     groups = ~spp,  
                                     slope = ~log(size),
                                     iter = 500,
                                     angle.type = "deg")

# Correct for multiple comparisons
pwHOS.pvals <- p.adjust(pwHOS.spp$P.slopes.dist, method = "hommel")  # Hommel is a more powerful method for independent hypothesis tests

# Export p-values
write.csv(pwHOS.pvals, "../Data/Results/19_02_25_static_pwHOS.csv")  # save in Results folder
```

## 2) Visualize static Allometry: Predicted Value
In _geomorph_, static allometry can be visualized with log(centroid size) plotted versus the predicted value of crania shape.
```{r}
# Run static allometry test with all specimens
spp.gdf <- geomorph.data.frame(shape = shape, spp = info$Taxa, size = info$Csize)
spp.results <- procD.allometry(shape ~ log(size), f2 = ~spp, iter = 500, data = spp.gdf)

# Set colors for genera and different points for species within each genus
info$EGenus <- info$Genus
info$EGenus[which(info$EGenus == "Mas")] <- "Pse"
pch.unique.spp <- PointOutDiffSpp(info)  # points by unique species in a genus for legend
pch.unique.spp[which(sort(unique(info$Taxa)) == "M_fus")] <- 2
pch.spp <- PlotByGroup(info, "Taxa", pch.unique.spp)  # pch coded for each individual

# Make color vector for legend
unique.taxa <- as.data.frame(unique(info[, c(6,10)]))
unique.taxa <- na.omit(unique.taxa[order(unique.taxa), ])
col.unique.spp <- PlotByGroup(unique.taxa, "EGenus", col.gen)

# Find the mean point for each static allometry
mean.size <- aggregate(spp.results$size, list(Taxa = info$Taxa), mean)
mean.shape <- aggregate(spp.results$Reg.proj, list(Taxa = info$Taxa), mean)

# Find the correlation
cor.static <- cor.test(log(spp.results$size), spp.results$Reg.proj, method = "pearson")
cor.static.assoc <- round(unname(cor.static$estimate), digits = 2)  # round to 3 sig figs
cor.static.assoc
cor.static$p.value
```

### Plot static and evolutionary allometry multipanel figure
```{r}
layout(matrix(c(1,1,2,2), 2, 2, byrow = TRUE))

# Plot of all data points with evolutionary allometry
par(mar = c(1, 4, 1.5, 0))
plot(x = log(spp.results$size),
     y = spp.results$Reg.proj,
     xlim = c(4.7, 6.4),
     col = sp.col.gen, 
     pch = pch.spp,
     bg = sp.col.gen,
     main = "Static and evolutionary allometry",
     xlab = NA,
     ylab = "Shape (Proj. Reg. Score)")
abline(lm(mean.shape$V1 ~ log(mean.size$x)), col = "dark grey", lwd = 2)  # plots evolutionary allometry

# Species Legend
legend(6.01, 0.06, legend = sort(unique(info$Taxa)), col = col.unique.spp, border = NULL, pch = pch.unique.spp, pt.bg = col.unique.spp, cex = 0.93, pt.cex = 0.8, ncol = 2, x.intersp = .3, y.intersp = 0.6)

# Plot of static allometry with evolutionary allometry
par(mar=c(5, 4, 1.5, 0))
plot(x = log(spp.results$size),
     y = spp.results$Reg.proj,
     xlim = c(4.7, 6.4),
     col = "white", 
     pch = pch.spp,
     bg = "white",
     xlab = "Log centroid size", 
     ylab = "Shape (Proj. Reg. Score)")
abline(lm(mean.shape$V1 ~ log(mean.size$x)), col = "dark grey", lwd = 2)  # plots evolutionary allometry
text(6.2, 0.02, paste("r = ", cor.static.assoc), cex = 1.3, col = "dark grey")

# Line segments to represent the static allometry for each species
taxa <- sort(unique(info$Taxa))  # ABC order
for(i in 1:length(taxa)) {
        # Isolate size and shape info for each taxon
        taxon.size <- spp.results$size[which(info$Taxa == taxa[i])]
        taxon.shape <- spp.results$Reg.proj[which(info$Taxa == taxa[i])]
        
        # Find parameters of regression line
        lm.params <- lm(taxon.shape ~ log(taxon.size))
        lm.slope <- unname(lm.params$coefficients[2])
        lm.int <- unname(lm.params$coefficients[1])

        # Draw regression line segment between min and max points 
        x.0 <- min(log(taxon.size))
        y.0 <- x.0 * lm.slope + lm.int  # y = mx + b
        x.1 <- max(log(taxon.size))
        y.1 <- x.1 * lm.slope + lm.int  # y = mx + b
        segments(x.0, y.0, x.1, y.1, col = col.unique.spp[i], lwd = 1.5)
}
```

### Create the same figure for genera (supplemental info)
```{r}
# Run allometry test on genera
gen.gdf <- geomorph.data.frame(shape = shape, gen = info$EGenus, size = info$Csize)
gen.results <- procD.allometry(shape ~ log(size), f2 = ~gen, iter = 500, data = gen.gdf)
summary(gen.results)

# Plot predicted allometric shape
plot(x = log(gen.results$size),
     y = gen.results$Reg.proj,
     xlim = c(4.7, 6.15),
     col = sp.col.gen, 
     pch = 16,
     main = "Allometric Shape by Genus",
     xlab = "Log centroid size", 
     ylab = "Shape (projected regression score)")
legend(6.04, 0.06, legend = names.phylo, col = col.phylo, pch = 16, cex = 0.60)
```

### Save intermediate data
```{r}
save(col.gen, sp.col.gen, col.phylo, names.phylo, file = "../Data/Processed/03-color-data.rda")
```