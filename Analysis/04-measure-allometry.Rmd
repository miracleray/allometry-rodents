---
title: "04-measure-allometry"
author: "Ariel Marcy & Thomas Guillerme"
date: "2019-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Quantifying differences in allometry
This script generates Table 1, Figure 3, supplementary Table S5 and supplementary Figure S2.

Changing size is one of the most common ways that organisms can change their shape. Modifications to growth during development often have a profound impact on adult shape. The tests in this script detect how much size appears to drive shape change in our sample, relative to phylogenetic association.

Our analyses here investigate allometry at three levels:
1) Static (within-species)
2) Evolutionary (among clades defined by Aplin 2014 as those that radiated in Australia from distinct ancestors)
3) Across all possible clades defined by our phylogenetic tree; this analysis was done mostly to ensure that our dataset was large enough to support our conclusions

### Load packages, functions, and data
```{r message = FALSE}
library("devtools")
devtools::install_github("geomorphR/geomorph", ref = "Stable", build_vignettes = TRUE)  # Install latest `geomorph`
library(geomorph)
library(RRPP)  # needed for pairwise comparisons with new `geomorph` > 3.1.0
library(landvR)  # must be version 0.4 or greater for rarefaction functions
library(stringr)
library(ape)  # phylogeny
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/03-main-data.rda")
load(file = "../Data/Processed/03-tree-data.rda")

# Optional once long analyses have been run
load(file = "../Data/Processed/04-allometry-data.rda")
load(file = "../Data/Processed/04-randomization-results.rda")  
```

## 1a) Measure static allometry with an ANCOVA (Procrustes ANOVA) -- reported in Table 1a
```{r}
# Run static allometry test with all specimens
static.gdf <- geomorph.data.frame(coords = shape, size = info$Csize, spp = info$Taxa)
fit.static <- procD.lm(coords ~ log(size) * spp, iter = 500, data = static.gdf, print.progress = FALSE)

# Round all values in ANCOVA table to 3 sig figs & remove NAs from the table
table1a <- as.data.frame(round(fit.static$aov.table, 3))
table1a[is.na(table1a)] <- ""

write.table(table1a, "../Data/Results/Table1a_ANOVA_spp.csv", sep = ",", col.names = NA)
```

### 1b) Measure static allometry: Homogeneity of Slopes Test by species
Run allometry tests as well as a homogeneity of slopes test. This test may take 1-2 min to run. Updated for `geomorph` v3.1.0. 
```{r}
# HOS test defined as a function for conciseness in the next block. Returns pairwise object from RRPP for Homogeneity of Slope comparisons
TestHOS <- function(shape, size, group, iter = 500, lm.fun) {
        # Data frame
        spp.gdf <- geomorph.data.frame(coords = shape, size = size, spp = group)
        # Models
        fit.unique <- lm.fun(coords ~ log(size) * spp, iter = iter, data = spp.gdf, RRPP = FALSE)  # unique allometries by spp
        fit.common <- lm.fun(coords ~ log(size) + spp, iter = iter, data = spp.gdf, RRPP = FALSE)  # common allometries across spp (NULL HYPOTHESIS)

        return(pairwise(fit.unique, fit.common, groups = spp.gdf$spp))
}

# Run with HOS dataset sampled above
pw.comp <- TestHOS(shape, info$Csize, info$Taxa, lm.fun = procD.lm) 

# Count number of significant pairwise comparisons of alloemtric slope
pw.summary <- summary.pairwise(pw.comp, test.type = "VC", angle.type = "deg", confidence = 0.99)  
actual.pw <- length(which(round(pw.summary$pairwise.tables$P, 3) < 0.01))

# Export p-value matrix to Results folder
write.csv(round(pw.summary$pairwise.tables$P, 3), "../Data/Results/TableS4_HOS.csv")
```

### 1c) Randomize specimens to get NULL expantancy for pairwise significant results
We'll do the randomization procedure 500 times. This takes at least 12 hours to run, so the results are saved in the gdf file in this script.
```{r}
# Define function to shuffle species attributions and run PW comparisons; this randomizes species relative to centroid size
null.pairwise <- function(shape, info, iter = 500, confidence = 0.99) {
        rand.spp <- sample(info$Taxa)
        
        # Run the test with random sample
        pw.comp <- TestHOS(shape, info$Csize, rand.spp, lm.fun = procD.lm)
        pw.summary <- summary.pairwise(pw.comp, test.type = "VC", angle.type = "deg", confidence = confidence, show.vectors = FALSE)
        
        # Count number of significant pairwise comparisons of allometric slope
        alpha <- 1 - confidence
        return(length(which(round(pw.summary$pairwise.tables$P, 3) < alpha)))
}

# Do this randomization and testing 100 times
set.seed(42)
count.pw <- NULL
for(i in 1:500){   # 100 iterations takes ~2.5 hours
        null.pw <- null.pairwise(shape = shape, info)
        count.pw <- c(count.pw, null.pw)
        print(i)  # meter to mullify impatience
}
```

### Visualize with histogram
```{r}
# Counts are divided by 2 because pairwise table repeats each comparison
hist((count.pw[1:length(count.pw)])/2, main = NULL, xlab = "Significant pairwise comparisons (alpha < 0.01)")
abline(v = actual.pw/2, lwd = 3, col = "red")  # compare random to real result above
```

## 2a) Run evolutionary allometry ANCOVA -- reported in Table 1b (n = 317, clades = 7)
This analysis is directly comparable to static ANCOVA above since only the grouping variable is changed.
```{r}
# Run static allometry test with all specimens
evo.gdf <- geomorph.data.frame(coords = shape, size = info$Csize, clade = info$Clade)
fit.evo <- procD.lm(coords ~ log(size) * clade, iter = 500, data = evo.gdf, print.progress = FALSE)

# Round all values in ANCOVA table to 3 sig figs & remove NAs from the table
table1b_n317 <- as.data.frame(round(fit.evo$aov.table, 3))
table1b_n317[is.na(table1b_n317)] <- ""

write.table(table1b_n317, "../Data/Results/Table1b_ANOVA_clade.csv", sep = ",", col.names = NA)
```

### 2b) Measure Evolutionary Allometry using clades and phylogeny -- Supplementary Table S5 (n = 37 species mean shapes, 7 clades)
Here we run Procrustes ANOVAs to compare the relative impact of PHYLO CLADE (Aplin 2014), size, and their interaction on shape.
```{r}
# Procrustes ANOVA with interaction
pgls.gdf <- geomorph.data.frame(coords = mean.shapes, size = info.means$MeanCsize, clade = info.means$Clade)

fit.pgls <- procD.pgls(coords ~ log(size) * clade, aus.tree, iter = 500, data = pgls.gdf, print.progress = FALSE)

# Round all values in ANCOVA table to 3 sig figs & remove NAs from the table
table1b_n37 <- as.data.frame(round(fit.pgls$aov.table, 3))
table1b_n37[is.na(table1b_n37)] <- ""

write.table(table1b_n37, "../Data/Results/TableS5_ANOVA_pgls.csv", sep = ",", col.names = NA)

# Find Reg Score values for plotting purposes later on (script 07)
evo.allo.rs <- plotAllometry(fit.pgls, size = info.means$MeanCsize, method = "RegScore")
```

### 2c) Test for power issue with species rich Pseudomys division
Rarefaction test in which 5 species from the Pseudomys division were randomly selected and the procD.pgls analysis re-run 100 times. 
```{r}
Pse.div <- info.means$FullName[which(info.means$Clade == "Pseudomys")]
count.R2 <- NULL
count.R2.p <- NULL

for (i in 1:100) {
    # Rarefy Pseudomys clade & cut down datsets accordingly
    not.in.sample <- sample(Pse.div, length(Pse.div) - 10)  # rarefy to 10 spp
    not.index <- match(not.in.sample, info.means$FullName)
    rare.info.means <- info.means[-not.index, ]  # metadata
    rare.mean.shapes <- mean.shapes[, , -not.index]  # shape data
    rare.tree <- drop.tip(aus.tree, not.in.sample)  # phylogeny
    
    # Run pgls 
    pgls.gdf.r <- geomorph.data.frame(coords = rare.mean.shapes, size = rare.info.means$MeanCsize, clade = rare.info.means$Clade)
    
    fit.pgls.r <- procD.pgls(coords ~ log(size) * clade, rare.tree, iter = 500, data = pgls.gdf.r, print.progress = FALSE)
    
    # Save R2 of interaction factor (3rd value)
    count.R2 <- c(count.R2, fit.pgls.r$aov.table$Rsq[3])
    count.R2.p <- c(count.R2.p, fit.pgls.r$aov.table$`Pr(>F)`[3])
    print(paste(i, fit.pgls.r$aov.table$Rsq[3], fit.pgls.r$aov.table$`Pr(>F)`[3]))  # meter to mullify impatience
}
```

### Visualize with histograms
Histogram of R2 result for the interaction factor (the most interesting result and only comparable statistic to other Procrustes ANOVAs). 
```{r}
setEPS()  # sets up plot export
postscript("../Data/Results/FigureR2_rare_pgls.eps")
layout(matrix(c(1,1,2,2), 2, 2, byrow = TRUE))

# Rsq value
par(mar = c(4, 4, 1.5, 0))
hist(count.R2[1:length(count.R2)], xlim = c(fit.pgls$aov.table$Rsq[3], range(count.R2)[2] + 0.01), main = NULL, xlab = "Interaction of size and clade Rsq value")
abline(v = fit.pgls$aov.table$Rsq[3], lwd = 3, col = "red")  # compare rarified results to actual result above

# P value
par(mar = c(5, 4, 1.5, 0))
hist(count.R2.p[1:length(count.R2.p)], xlim = c(fit.pgls$aov.table$`Pr(>F)`[3], range(count.R2.p)[2] + 0.01), main = NULL, xlab = "Interaction of size and clade p value")
abline(v = fit.pgls$aov.table$`Pr(>F)`[3], lwd = 3, col = "red")  # compare rarified results to actual result above

dev.off()
```

## 3) Measure allometric slope change using phylogenetic rarefaction
This addresses reviewer concerns over small sample sizes in each species bin and whether it underlies some or all of our results showing parallel slopes across almost all species. The code below is based on Dr Thomas Guillerme's [landvR vignette here](https://github.com/TGuillerme/landvR/blob/master/inst/vignettes/rarefy_regressions.Rmd)

### Get each clade from the phylogeny
First we need to identify and isolate each element from each partition (clade) using a modified version from the `ape::prop.part` function.
```{r}
# Create simple data table with label, centroid size, and Reg Score
short.label <- function(label) paste0(substr(strsplit(label, split = "_")[[1]][1], 1, 1), "_", substr(strsplit(label, split = "_")[[1]][2], 1, 3))
aus.tree.stlbl <- aus.tree
aus.tree.stlbl$tip.label <- unname(sapply(aus.tree.stlbl$tip.label, short.label))

static.allo.rs <- plotAllometry(fit.static, size = static.gdf$size, method = "RegScore")

rare.table <- data.frame(info$Taxa, log(info$Csize), unname(static.allo.rs$RegScore))
colnames(rare.table) <- c("Taxa", "Csize", "RegProj")
rownames(rare.table) <- NULL

# Getting the tree partitions (with singletons) with function defined in landvR and modified from ape
clades <- prop.part.names(aus.tree.stlbl, singletons = TRUE)

# Make function for getting the dataset for each clade
get.data.clade <- function(clade, data, species.col.n, data.cols) {
    return(data[which(data[, species.col.n] %in% clade), data.cols])
}

# Use function to get all the datasets per clades
data.clades <- lapply(clades, get.data.clade, data = rare.table,
                      species.col.n = 1, data.cols = c(2:3))  # 2:3 corresponds to Csize and RegProj in rare.table
```

### Apply the test to each clade
We can then calculate the delta slope (observed - rarefied slope) by using the lowest potential number of specimens in our dataset (5 - see above).
```{r}
# First define function for getting the slope of a linear model
GetSlope <- function(data) {
    return(lm(data)$coefficients[[2]])  # gives m, slope from y = mx + error
}

# Get observed slopes
obs.slopes <- unlist(lapply(data.clades, GetSlope))

# Get the rarefied statistics for DELTA SLOPES each clade with rarefy.stat, another new function in landvR
delta.slopes <- lapply(data.clades, rarefy.stat, stat.fun = GetSlope, rarefaction = 5)  # 5 = the lowest n of specimens for a species in our dataset
```

### Summarize the results
We can then summarise these results per clade size (that's already done in this example) and adding the clade names (if they exist):
```{r}
# Clean up axis labels for plotting
new.names <- unlist(lapply(clades, paste, collapse = "+"))
for(i in 1:length(new.names))
    if(nchar(new.names[i]) > 5) {  # detect bins of greater than 1 spp
        new.names[i] <- ((nchar(new.names[i]) + 1) / 6)  # gets number of spp
    }

# Some vanity names for plotting
new.names[1] <- "All 37"
new.names[2] <- "No Mus 36"
new.names[3] <- "AOE 28"
new.names[which(new.names == 11)] <- "Pse 11"
new.names[which(new.names == 8)] <- "Rat 8"
new.names[25] <- "Not 4"
new.names <- str_replace(new.names, "_", " ")
```

### Test for "significant" delta slopes
4.5 degrees is an ideal cut-off because absolute value of angle change can only vary from 0-90 therefore a 5% variation from 90 is 90*0.5 = 4.5 degrees.
```{r}
# Define function to test for significant delta slopes
test.delta.slope <- function(obs.slope, delta.slope, significance) {
    denom <- (1 + obs.slope * (obs.slope + delta.slope))
    angle <- abs(atan(delta.slope/denom) * 180/pi)  # converts angle into deg
    if(!missing(significance)) {
        return(ifelse(angle < significance, TRUE, FALSE))  # FALSE = failed the signifance level
    } else {
        return(angle)
    }
}

# Test our dataset
med.delta.slopes <- unlist(lapply(delta.slopes, median))
med.delta.slopes[which(is.na(med.delta.slopes))] <- 0  # account for NAs
is.parallel <- test.delta.slope(obs.slopes, med.delta.slopes, significance = 4.5)
sum(is.parallel)  # number of clades with less than 4.5 deg angle change

# Get angle change values for plotting 
denom <- (1 + obs.slopes * (obs.slopes + med.delta.slopes))
angle.changes <- abs(atan(med.delta.slopes/denom) * 180/pi)  # angles in deg
```

### Plot the results: Delta slope in CI boxplot and Delta angle as a histogram -- reported as Figure 3
```{r}
setEPS()  # sets up plot export
postscript("../Data/Results/Figure3_Phylo_Rare.eps")
layout(matrix(c(1,1,2,2), 2, 2, byrow = TRUE))

# 3a) Delta slope as a bloxplot
par(mar = c(1, 4, 1.5, 1))
boxplot(delta.slopes, border = "white", ylim = quantile(unlist(delta.slopes), probs = c(0.01, 0.99), na.rm = TRUE), ylab = "Delta slope", xlab = NULL, names = rep("", length(new.names)))  # an empty plot needed first

plot.CI(delta.slopes, type = "polygon", CI = c(95, 50), cent.tend = median, point.col = "black")
text(0.5, 15, "a", cex = 2)
abline(h = 0, col = 'coral4')

# 3b) Delta angle (in degrees) as a histogram
par(mar = c(5, 4, 0, 1))
plot(c(1:length(med.delta.slopes)), angle.changes, xlab = "Clade (n species in clade and/or species name)", ylab = "Median delta angle (\u00B0)", pch = 16, ylim = c(0,90), xaxt = 'n')
axis(side = 1, at = c(1:73), labels = new.names, las = 2, cex.axis = 0.8)
text(0.5, 85, "b", cex = 2)
abline(h = 4.5, col = "coral4")  # significance level
text(1, 7, "4.5 degree significance level", adj = c(0,0), col = "coral4")

dev.off()
```

## Check the validity of the results above by randomizing species into "fake clades"
First create some fake clade groupings (i.e. non phylogenetic) and connect it to real data by individuals
```{r}
# Getting the same number of "groups" per "clades"
clades <- prop.part.names(aus.tree, singletons = FALSE)
n.spp.group <- sort(unlist(lapply(clades, length)), decreasing = TRUE)  # sort by big->small for graphing at the end

# Make function to get rarefied statistics for a fake clade grouping
RareFlakes <- function(n.spp.group, rare.table) {
        # Spp names for each fake clade as per n in each clade
        fake.clades <- lapply(n.spp.group, function(n.spp.group, names = rare.table$Taxa) sample(names, n.spp.group))
        
        # Use get.data.clade function from above to grab datasets for clades
        data.flakes <- lapply(fake.clades, get.data.clade, data = rare.table, species.col.n = 1, data.cols = c(2:3))
        
        # Get the rarefied statistics for each clade
        delta.slopes <- lapply(data.flakes, rarefy.stat, stat.fun = GetSlope, rarefaction = 5)
        
        return(delta.slopes)
}
```

### Apply the tests to the "fake clades" x 100
Again, calculate the delta slope (observed - rarefied slope) by using the lowest potential number of specimens in our dataset (5 - see above).
```{r}
f.delta.slopes <- list()
set.seed(802)  # Go Lake Monsters! 
for(i in 1:100) {  # Rep 100 times
        f.delta.slopes[[i]] <- do.call(cbind, RareFlakes(n.spp.group, rare.table))
}
fake.results.table <- do.call(rbind, f.delta.slopes)  # full matrix of slope values
colnames(fake.results.table) <- n.spp.group  # summarize results by clade size
``` 

### Summarize the results -- Supplementary Figure 2
Transform these statistics into tables to simply plot them with `boxplot`:
```{r, fig.width = 12, fig.height = 12}
setEPS()
postscript("../Data/Results/FigureS2_FakeClades.eps")

# An empty plot first
fake.results.list <- apply(fake.results.table, 2, list)
colnames(fake.results.table) <- n.spp.group
boxplot(fake.results.table, border = "white", ylim = quantile(unlist(fake.results.table), probs = c(0.01, 0.99), na.rm = TRUE), ylab = "Delta slope", xlab = "Number of species in fake clade", names = new.names[1:length(n.spp.group)], las = 2, cex.axis = 0.8)

# Add the results
plot.CI(unlist(fake.results.list, recursive = FALSE), type = "polygon", CI = c(50, 95), cent.tend = median, point.col = "black")
abline(h = 0, col = "coral4")

dev.off()
```

## Save intermediate data and data that takes a long time to generate
```{r}
save(fit.static, fit.evo, fit.pgls, static.allo.rs, evo.allo.rs, file = "../Data/Processed/04-allometry-data.rda")  # allometric data needed for plotting in script 07

save(count.pw, delta.slopes, angle.changes, f.delta.slopes, fake.results.list, file = "../Data/Processed/04-randomization-results.rda")  # data saved from procedures that take a long time to run, namely the null hypothesis test for pairwise static allometric slope comparisons, the phylogenetic rarefaction, and the 100 "fake" clades rarefaction
```