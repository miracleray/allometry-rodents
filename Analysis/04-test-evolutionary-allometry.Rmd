---
title: "04-test-evolutionary-allometry"
author: "Ariel Marcy"
date: "2019-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Evolutionary allometry with Procrustes ANOVA
Evolutionary studies must take into account the phylogenetic tree because related species do not behave the same as independent samples. 

This script generates Table 1.

### Load packages, functions, and data
```{r message = FALSE}
library(data.table)
library(vegan)
library(stringr)
library(geomorph)
library(ape)  # needed to work with phylogenies
library(geiger)  
library(phylotate)  
library(phytools)  
source("../Functions/utilities.R")  # loads custom functions
source("../Functions/phytools.branch.colors.R")  # modified phytools function
load(file = "../Data/Processed/02-main-data.rda")
load(file = "../Data/Processed/03-color-data.rda")
```

## Visualize tree for Figure 1
Phylogeny with branch colors coordinated to centroid size and tip labels colors coordinated to major clades (see script 03)
```{r}
# Branch colors by centroid size
cs.tree <- -info.means.tree$MeanCsize  # negative so colors get darker with larger size
names(cs.tree) <- aus.tree$tip.label

# Tip lable colors by species, ordered in same way as tree
grp <- as.factor(str_sub(aus.tree$tip.label, 1, 3))
grp[which(grp == "Mas")] <- "Pse"
names(col.gen) <- sort(unique(grp))
col.tree <- col.gen[match(grp, names(col.gen))]

# Make Figure 1
setEPS()
postscript("../Data/Results/Figure1_Phylogeny_CS.eps")

plotBranchbyTrait(aus.tree, -cs.tree, mode = "tips", palette = "gray", tip.color = col.tree, legend = FALSE)

# Add centroid size legend
legend_image <- as.raster(matrix(gray.colors(5), ncol = 1))
rasterImage(legend_image, 0, 2, 4, 5)
text(2, 6, "Large", col = "dark grey", cex = 1)
text(2, 1, "Small", col = "dark grey", cex = 1)

dev.off()
```

## Evolutionary Allometry, reported in Table 1
Here we run Procrustes ANOVAs to compare the relative impact of PHYLO CLADE (Aplin 2014), size, and their interaction on shape.
```{r}
# Remove clades with only one species (Mus and Pogonomys)
one.spp <- c(which(info.means.tree$Clade == "Mus"), which(info.means.tree$Clade == "Pogonomys"))  # index for removal
e.info.means.tree <- info.means.tree[-one.spp, ]  # metadata
e.mean.shapes.tree <- mean.shapes.tree[, , -one.spp]  # shape data
e.aus.tree <- drop.tip(aus.tree, c("Mus_musculus", "Pogonomys_mollipilosis"))  # phylo tree

# Procrustes ANOVA with interaction
evo.allo.clade.gdf <- geomorph.data.frame(Shape = e.mean.shapes.tree, size = e.info.means.tree$MeanCsize, Clade = factor(e.info.means.tree$Clade))

evo.allo.clade <- procD.lm(Shape ~log(size) * Clade, iter = 500, data = evo.allo.clade.gdf)
evo.allo.clade.2$aov.table
```

### Do pairwise comparisons to see which phylo groups are significantly different
```{r}
pairwise.clade <- pairwise(evo.allo.clade, groups = evo.allo.clade.gdf$Clade)

summary(pairwise.clade, confidence = 0.95, test.type = "VC", angle.type = "deg")  # correlation between mean vectors (angles in degrees)
```

### Export Tables 1a,b as CSV files
```{r}
# Round all values to 3 decimals and remove NAs from the tables
table1a <- as.data.frame(round(spp.results$aov.table, 3))
table1a[is.na(table1a)] <- ""

table1b <- as.data.frame(round(evo.allo.gen$aov.table, 3))
table1b[is.na(table1b)] <- ""

# Export
write.table(table1a, "../Data/Results/Table1a_species_ANOVA.csv", sep = ",", col.names = NA)
write.table(table1b, "../Data/Results/Table1b_genus_ANOVA.csv", sep = ",", col.names = NA)
```

### Save intermediate data
```{r}
save(concord, relabel.tree, mean.shapes.tree, info.means.tree, aus.tree, file = "../Data/Processed/04-phylo-data.rda")
```


## Recycling bin
phylogenetically-adjusted analyses
```{r}
evo.allo.clade <- procD.pgls(Shape ~log(size) * Clade, e.aus.tree, iter = 500, data = evo.allo.clade.gdf)
evo.allo.clade$aov.table

fit.null <- procD.pgls(Shape ~log(size) + Clade, e.aus.tree, iter = 500, data = evo.allo.clade.gdf)

pairwise.clade <- pairwise(evo.allo.clade, fit.null, groups = evo.allo.clade.gdf$Clade)

summary(pairwise.clade, confidence = 0.95, test.type = "VC", angle.type = "deg")  # correlation between mean vectors (angles in degrees)
```

Here we run Procrustes ANOVAs to compare the relative impact of GENUS, size, and their interaction on shape.
```{r}
# Procrustes ANOVA with interaction
evo.allo.gen.gdf <- geomorph.data.frame(Shape = mean.shapes.tree, size = info.means.tree$MeanCsize, Genus = info.means.tree$Genus)

evo.allo.gen <- procD.pgls(Shape ~log(size) * Genus, aus.tree, iter = 500, data = evo.allo.gen.gdf)
evo.allo.gen$aov.table
```
